<!DOCTYPE html>
<!--
 * Copyright (c) 2010 The Chromium Authors. All rights reserved.  Use of this
 * source code is governed by a BSD-style license that can be found in the
 * LICENSE file.
-->
<html>
  <head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js" type="text/javascript"></script>
    <script>
	var request1;
	var xhreq;
	var regex1=/Finished: SUCCESS/;
	var cons=/console/;
	var buildFin;
	var url;
	var buildStarted;
      // Called when a message is passed.  We assume that the content script
      // wants to show the page action.
      function onRequest(request, sender, sendResponse) {
        // Show the page action for the tab that the sender (content script)
        // was on.
        
		//alert(getUrl(sender.tab.url));
		chrome.pageAction.show(sender.tab.id);
		chrome.pageAction.setIcon({path:"B&R.png",tabId:sender.tab.id});
        
		
		if(cons.test(sender.tab.url)){
		request1=null
		//console.log("sender.tab.url "+ sender.tab.url);
		url=sender.tab.url;
		buildStarted=0;
		buildFin=0;
		testBuild();
		}
        sendResponse({});
      }

		
 function getUrl(Url)
 {
 
 var pos=Url.lastIndexOf("console");
 
 if(pos==-1)
 return ""
 else
 return Url.slice(0,pos);
 
 }

 function testBuild()
{
	//console.log("URL: " +url);
		if(request1==null)
		{
		//console.log("testbuild req=false|null");
		
		doRequest();
		
		//sleep(5000);
		}
		if(request1=="success")
		{
		//console.log("req==true");
		//console.log("testbuild req=true");
		
		var notification = webkitNotifications.createNotification('B&R.png', 'success','Build Successfull');
		notification.show();
		}
		if(request1=="failure")
		{
		var notification = webkitNotifications.createNotification('B&R.png', 'failure','Build Failed');
		notification.show();
		}
		
		if(request1=="building")
		{
		if(buildStarted<1)
		{
		//console.log("testbuild req=building");
		var notification = webkitNotifications.createNotification('B&R.png', 'Building','Build Started');
		notification.show();
		buildStarted++;
		}
		doRequest();
		}
				
}

function doRequest()
{
var tabUrl=getUrl(url);
//console.log("tab: "+tabUrl);

var auth = null;
	   if (xhreq) {
					xhreq.abort();
				}
				xhreq = new XMLHttpRequest();
				
				try {
					xhreq.onreadystatechange = checkResponse;
					//xhreq.onerror = handleError;
					xhreq.open('GET', tabUrl + 'api/json', true);
					if (typeof auth == 'string') {
						xhreq.setRequestHeader('Authorization', 'Basic ' + auth);
					}
					xhreq.send();
				} catch (e) {
					
				}

 
 //request1=true;
 }

 
 
function checkResponse() {
				 if (xhreq.readyState != 4) return;
				if (xhreq.status == 200 && xhreq.responseText) {
					var response = JSON.parse(xhreq.responseText);
					//console.log("JSON.parse done");
					//console.log("building :"+response.building);
					//console.log("result :"+response.result);
					if(!response.building && response.result=="SUCCESS")
					{
					
					//console.log("build success");
					request1="success";
					//return true;
					//buildFin++;
					}
					else if(!response.building && response.result=="FAILURE")
					{
					//console.log("build fail");
					request1="failure";
					}
					else if(response.building)
					{
					//console.log("building");
					request1="building";
					}
					}
				else
				{
				
				}
				//console.log("chkresponse");
				setTimeout("testBuild()",1000);
			return;

			}


      // Listen for the content script to send a message to the background page.
      chrome.extension.onRequest.addListener(onRequest);
    </script>
  </head>
</html>
