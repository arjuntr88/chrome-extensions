<!DOCTYPE html>
<!--
 * Copyright (c) 2010 The Chromium Authors. All rights reserved.  Use of this
 * source code is governed by a BSD-style license that can be found in the
 * LICENSE file.
-->
<html>
  <head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js" type="text/javascript"></script>
    <script>
	var request1;
	var regex1=/Finished: SUCCESS/;
	var cons=/console/;
	var buildFin;
      // Called when a message is passed.  We assume that the content script
      // wants to show the page action.
      function onRequest(request, sender, sendResponse) {
        // Show the page action for the tab that the sender (content script)
        // was on.
        buildFin=request;
		//alert(getUrl(sender.tab.url));
		chrome.pageAction.show(sender.tab.id);
		chrome.pageAction.setIcon({path:"B&R.png",tabId:sender.tab.id});
        // Return nothing to let the connection be cleaned up.
	/* 	if (window.webkitNotifications) {
		console.log("Notifications are supported!");
		}
		else {
		console.log("Notifications are not supported for this Browser/OS version yet.");
		} */
		
		if(cons.test(sender.tab.url)){
		alert("");
		testBuild();
		
		//alert(getUrl(sender.tab.url));
		//testBuild();
	/* 	if(request!=true)
		{
		
		console.log("req!=true");
		//testBuild();
		
		
		}
		if(request==true)
		{
		console.log("req==true");
		var notification = webkitNotifications.createNotification('B&R.png', 'success','Build Successfull');
		notification.show();
		} */
		

		
		}
        sendResponse({});
      };
/* 	  function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e15; i++) {
    if ((new Date().getTime() - start) > milliseconds){
      break;
    }
  }
} */
	

		/*  function testBuild()
		{
		
		chrome.tabs.executeScript(null, {file: 'content_script.js'});
		}  */
		
 function getUrl(Url)
 {
 
 var pos=Url.lastIndexOf("console");
 
 if(pos==-1)
 return ""
 else
 return Url.slice(0,pos);
 
 }

 function testBuild()
{
alert("");
		/* if(request1!=true)
		{
		//alert("'");
		//console.log("req!=true");
		
		testBuild1();
		//sleep(5000);
		}
		if(request1==true)
		{
		//console.log("req==true");
		var notification = webkitNotifications.createNotification('B&R.png', 'success','Build Successfull');
		notification.show();
		} */
				
}
var xhr;
function testBuild1()
{
var tab.url=getUrl(sender.tab.url);
var auth = null;
	   if (xhr) {
					xhr.abort();
				}
				xhr = new XMLHttpRequest();
				//window.clearTimeout(abortTimer);
				//abortTimer = window.setTimeout(xhr.abort, REQUEST_TIMEOUT);
				try {
					xhr.onreadystatechange = checkResponse;
					//xhr.onerror = handleError;
					xhr.open('GET', tab.url + 'api/json', true);
					if (typeof auth == 'string') {
						xhr.setRequestHeader('Authorization', 'Basic ' + auth);
					}
					xhr.send();
				} catch (e) {
					//handleError(e);
				}

 //alert(sender.tab.url);
 //request1=true;
 }

 function getUrl(Url)
 {
 alert(Url);
 var pos=Url.lastIndexOf("console");
 alert(pos);
 if(pos==-1)
 return ""
 else
 return Url.slice(0,pos);
 
 }
 
 
function checkResponse() {
				/*  if (xhr.readyState != 4) return;
				if (xhr.status == 200 && xhr.responseText) {
					var response = JSON.parse(xhr.responseText);
					
					return true;
					}
				else
				{
				
				} */
				request1=true;
				setTimeout("testBuild()",100);
				/*if (xhr.status == 200 && xhr.responseText) {
					var response = JSON.parse(xhr.responseText);
					var topStatus = -1;
					if (response.jobs) {
						jobs = response.jobs;
						if (localStorage.sorting == 'status') {
							jobs.sort(sortByStatus);
						} else {
							jobs.sort(sortByName);
						}
						for (var i in response.jobs)
							topStatus = Math.max(topStatus, STATUSES[response.jobs[i].color]);
					}
					//handleSuccess(topStatus);
					return;
				} else {
					//handleError(xhr.status != 200 ? 'HTTP ' + xhr.status : 'No responseText found');
					return;
				} */
			}


      // Listen for the content script to send a message to the background page.
      chrome.extension.onRequest.addListener(onRequest);
    </script>
  </head>
</html>
